<template>
  <div>
    <v-error-info :errMsg="errMsg"></v-error-info>
    <div class="demo-color-box bg-blue">申报官注册</div>
    <el-form ref="form" :rules="rules" :model="form" label-width="80px" label-position="top">
      <el-form-item label="姓 名" prop="name">
        <el-input v-model="form.name" placeholder="请输入申报官真实姓名"></el-input>
      </el-form-item>
      <el-form-item label="手机号码" prop="cellphone">
        <el-input v-model="form.cellphone" placeholder="请输入手机号码"></el-input>
      </el-form-item>
      <el-form-item label="验证码" prop="code">
        <el-input v-model="form.code" placeholder="请输入验证码"></el-input>
      </el-form-item>
      <el-form-item label="">
        <el-button @click="sendMsg" type="primary" :disabled="isDisabled">{{buttonName}}</el-button>  
      </el-form-item>
      <el-form-item label="常住区域" prop="liveAddress">
        <v-area :handler="areaHandler"></v-area>
      </el-form-item>
      <el-form-item label="详细地址" prop="address">
        <el-input v-model="form.address" placeholder="请输入详细地址"></el-input>
      </el-form-item>
      <el-form-item label="寸 照" prop="portrait">
        <v-multiple-upload len="1" title="上传寸照" @acceptData="setPortrait" uploadid="upload1"></v-multiple-upload>
      </el-form-item>
      <el-form-item label="身份证号" prop="idNumber">
        <el-input v-model="form.idNumber" placeholder="请输入身份证号码"></el-input>
      </el-form-item>
      <el-form-item label="身份证照片正面" prop="idFrontUrl">
        <v-multiple-upload len="1" uploadid="upload2" title="上传正面" @acceptData="setFrontUrl"></v-multiple-upload>
      </el-form-item>
      <el-form-item label="身份证照片背面" prop="idBackUrl">
        <v-multiple-upload len="1" uploadid="upload3" title="上传背面" @acceptData="setBackUrl"></v-multiple-upload>
      </el-form-item>
      <el-form-item label="尽职调查表" prop="surveyImageUrl">
        <v-multiple-upload len="5" title="上传尽职调查表" @acceptData="setSurveyImageUrl" uploadid="upload4"></v-multiple-upload>
      </el-form-item>
      <el-form-item label="">
        <a download :href="template.sbgjzdcb"><el-button type="primary">下载尽职调查表</el-button></a>
      </el-form-item>
      <el-form-item label="承诺公函" prop="letterImageUrl">
        <v-multiple-upload len="1" title="上传承诺公函" @acceptData="setLetterImageUrl" uploadid="upload5"></v-multiple-upload>
      </el-form-item>
      <el-form-item label="">
        <a download :href="template.sbgcngh"><el-button type="primary">下载承诺公函</el-button></a>
      </el-form-item>
      <el-form-item label="推荐码">
        <el-input v-model="form.recommendId" placeholder="请输入推荐码"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="onSubmit('form')">提交</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>
<script>
import area from '@/components/area/mobileArea';
import multipleUpload from '@/components/upload/multipleUpload';
import ru from '@/config/rules';
import { DECLARE_GET_VALIDATECODE, EXCEL_SERVER_URL, DECLARE_PUBLICS_POST_DECLARER, PUBLICS_GET_CHECK_CELLPHONE } from '@/config/env';
import errInfo from '@/components/info/error';

export default {
  data() {
    return {
      template: {
        sbgjzdcb: `${EXCEL_SERVER_URL}/template/sbgjzdcb.docx`,
        sbgcngh: `${EXCEL_SERVER_URL}/template/sbgcngh.docx`,
      },
      errMsg: [],
      buttonName: '获取验证码',
      isDisabled: false,
      time: 60,
      formInline: {
      },
      form: {
        name: '',
        cellphone: '',
        code: '',
        liveAddress: '',
        address: '',
        portrait: '',
        idNumber: '',
        idFrontUrl: '',
        idBackUrl: '',
        surveyImageUrl: '',
        letterImageUrl: '',
        recommendId: '',
      },
      rules: {
        name: [
          { required: true, message: '请输入姓名', trigger: 'blur' },
          { min: 2, max: 4, message: '长度在 2 到 4 个字符', trigger: 'blur' },
        ],
        cellphone: [
          { validator: this.validatePhone, trigger: 'blur' },
          { required: true, message: '请输入手机号码', trigger: 'blur' },
        ],
        liveAddress: [
          { required: true, message: '请输入常住区域', trigger: 'change' },
        ],
        address: [
          { required: true, message: '请输入详细地址', trigger: 'blur' },
        ],
        code: [
          { required: true, message: '请输入验证码', trigger: 'blur' },
        ],
        portrait: [
          { required: true, message: '请上传寸照', trigger: 'change' },
        ],
        idNumber: [
          { validator: this.validateIdCard, trigger: 'blur' },
          { required: true, message: '请输入身份证号', trigger: 'blur' },
        ],
        idFrontUrl: [
          { required: true, message: '请上传身份证正面', trigger: 'change' },
        ],
        idBackUrl: [
          { required: true, message: '请上传身份证背面', trigger: 'change' },
        ],
        surveyImageUrl: [
          { required: true, message: '请上传尽职调查表', trigger: 'change' },
        ],
        letterImageUrl: [
          { required: true, message: '请上传承诺公函', trigger: 'change' },
        ],
      },
    };
  },
  components: {
    'v-area': area,
    'v-multiple-upload': multipleUpload,
    'v-error-info': errInfo,
  },
  methods: {
    async validatePhone(rule, value, callback) {
      if (!ru.mPattern.pattern.test(value)) {
        callback(new Error(ru.mPattern.message));
        return;
      }
      await this.$xhr('get', `${PUBLICS_GET_CHECK_CELLPHONE}${this.form.cellphone}`);
      callback();
    },
    validateIdCard(rule, value, callback) {
      if (!ru.cP.pattern.test(value)) {
        callback(new Error(ru.mPattern.message));
        return;
      }
      callback();
    },
    setFrontUrl(d) {
      this.form.idFrontUrl = d;
    },
    setBackUrl(d) {
      this.form.idBackUrl = d;
    },
    setLiveAddress(d) {
      this.form.liveAddress = d;
    },
    setPortrait(d) {
      this.form.portrait = d;
    },
    setSurveyImageUrl(d) {
      this.form.surveyImageUrl = d;
    },
    setLetterImageUrl(d) {
      this.form.letterImageUrl = d;
    },
    async onSubmit(formName) {
      this.$refs[formName].validate(async (valid) => {
        if (valid) {
          const res = await this.$xhr('post', DECLARE_PUBLICS_POST_DECLARER, this.form);
          if (res.data.success) {
            this.$router.push('/officer/registerSuccess');
          } else {
            this.isShowSubmit = !this.isShowSubmit;
          }
          return true;
        }
        return false;
      });
    },
    areaHandler(d) {
      this.form.liveAddress = d;
    },
    async sendMsg() {
      if (!this.form.cellphone) return;
      const me = this;
      me.isDisabled = true;
      const interval = window.setInterval(() => {
        me.buttonName = `（${me.time}秒）后重新获取`;
        me.time -= 1;
        if (me.time < 0) {
          me.buttonName = '重新获取';
          me.time = 10;
          me.isDisabled = false;
          window.clearInterval(interval);
        }
      }, 1000);
      const res = await this.$xhr('get', `${DECLARE_GET_VALIDATECODE}addDeclarer/${this.form.cellphone}`);
      if (!res.data.code === 0) {
        this.errMsg.push(res.data.message);
      }
    },
  },
};

</script>
<style lang="scss" scoped>
html,body {
  margin: 0;
  padding: 0;
}
.bg-blue {
    background-color: #409eff;
}
.demo-color-box {
    padding: 20px;
    margin: 5px 0;
    height: 74px;
    box-sizing: border-box;
    color: #fff;
    font-size: 30px;
    text-align: center;
    line-height: 34px;
    color: #fff;
}
.el-button--primary {
	width: 100%
}
</style>